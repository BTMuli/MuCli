#!/usr/bin/env node
import e from"process";import{__awaiter as t,__generator as n,__spreadArray as r}from"tslib";import{Command as a}from"commander";import i from"inquirer";import{resolve as o}from"path";import c from"app-root-path";import s from"fs-extra";import u from"yamljs";import{exec as l}from"child_process";import d from"chalk";import m from"ora";import p from"assert";var f;function v(){return c.path}function h(){var e=c.resolve("package.json");return s.readJSONSync(e)}function y(e){return h().subVersion[e]}function b(e){void 0===e&&(e=!1);var t=c.resolve("config"),n=o(t,"default.yml");if(e)return n;var r=u.load(n).update,a=o(t,"user.yml");return s.existsSync(a)||s.copyFileSync(n,a),u.load(a).update<r&&s.copyFileSync(n,a),a}function g(e){void 0===e&&(e=!1);var t=b(e);return u.load(t)}function w(){var e=g(),t=[];return e.dev.enable&&t.push("dev"),e.mmd.enable&&t.push("mmd"),t}!function(e){e.dev="dev",e.mmd="mmd"}(f||(f={}));var S=new a;S.name("muc").description(h().description).version(h().version,"-v, --version"),S.command("set").description("set subcommand on or off").action((function(){return t(void 0,void 0,void 0,(function(){var e,r,a;return n(this,(function(o){switch(o.label){case 0:return e=["dev","mmd"],r=w(),a=e.map((function(e){return r.includes(e)?{name:e,value:e,checked:!0}:{name:e,value:e,checked:!1}})),[4,i.prompt([{type:"checkbox",name:"command",message:"Please select the subcommand you want to open",choices:a}]).then((function(e){return t(void 0,void 0,void 0,(function(){return n(this,(function(t){return function(e){var t=g();t.dev.enable=e.includes("dev"),t.mmd.enable=e.includes("mmd");var n=b();s.writeFileSync(n,u.stringify(t,4,2))}(e.command),[2]}))}))}))];case 1:return o.sent(),[2]}}))}))}));var F=new a("dev"),D=y(f.dev);function k(){return t(this,void 0,void 0,(function(){var e;return n(this,(function(t){switch(t.label){case 0:return[4,i.prompt([{type:"list",name:"type",message:"What do you want to do about label?",choices:[{name:"See all labels",value:"see"},{name:"Create a new label",value:"create"},{name:"Update a label",value:"update"},{name:"Delete label(s)",value:"delete"},{name:"Do nothing",value:"nothing"}]}])];case 1:switch(e=t.sent(),e.type){case"see":return[3,2];case"create":return[3,4];case"update":return[3,6];case"delete":return[3,8];case"nothing":return[3,10]}return[3,11];case 2:return[4,x()];case 3:case 5:case 7:case 9:return t.sent(),[3,11];case 4:return[4,E()];case 6:return[4,M()];case 8:return[4,j()];case 10:return[3,11];case 11:return[2]}}))}))}function A(e){return"[filename] ".concat(d.yellow(e.filename)," [author] ").concat(d.yellow(e.author)," [description] ").concat(d.yellow(e.description))}function x(){return t(this,void 0,void 0,(function(){var e,t,r,a,i,o;return n(this,(function(n){if(e=g(),t=e.mmd.defaultLabel,console.log(d.green("Default label:"),A(t)),r=e.mmd.labels,console.log(d.green("Custom labels:")),0===r.length)return console.log(d.yellow("\tNo custom labels")),[2];for(a=0,i=r;a<i.length;a++)o=i[a],console.log("\t",A(o));return[2]}))}))}function E(e){return t(this,void 0,void 0,(function(){var t,r,a,o,c,l,d;return n(this,(function(n){switch(n.label){case 0:return t=g(),r=t.mmd.labels,a=t.mmd.defaultLabel,[4,i.prompt([{type:"input",name:"filename",message:"Filename:",default:null!=e?e:""}])];case 1:return(o=n.sent())===a.filename||r.some((function(e){return e.filename===o.filename}))?(o.filename===a.filename&&m("The label is already exists as the default label!").fail(),void 0===(c=r.find((function(e){return e.filename===o.filename})))?[2]:[4,i.prompt([{type:"confirm",name:"confirm",message:"The label already exists, do you want to update the label ?\n".concat(A(c))}])]):[3,4];case 2:return!1===(l=n.sent()).confirm?[2]:[4,M(o.filename)];case 3:return n.sent(),[3,7];case 4:return[4,i.prompt([{type:"input",name:"author",message:"Author:"},{type:"input",name:"description",message:"Description:"}])];case 5:return l=n.sent(),d={filename:o.filename,author:l.author,description:l.description},[4,i.prompt([{type:"confirm",name:"confirm",message:"Do you want to create the label ?\n".concat(A(d))}])];case 6:if(!1===n.sent().confirm)return[2];r.push(d),t.mmd.labels=r,s.writeFileSync(b(),u.stringify(t,4,2)),n.label=7;case 7:return[2]}}))}))}function M(e,r){return t(this,void 0,void 0,(function(){var t,r,a,o,c,l;return n(this,(function(n){switch(n.label){case 0:return[4,i.prompt([{type:"input",name:"input",message:"Please input the filename of the label you want to update:",default:null!=e?e:""}])];case 1:return t=n.sent(),r=g().mmd.labels,a=r.find((function(e){return e.filename=t.input})),0!==r.length&&void 0!==a?[3,4]:[4,i.prompt([{type:"confirm",name:"confirm",message:"The label is not exist yet, create a new ?",default:!0}])];case 2:return!1===(o=n.sent()).confirm?[2]:[4,E(t.input)];case 3:return n.sent(),[3,7];case 4:return p(void 0!==a),[4,i.prompt([{type:"input",name:"author",message:"Author: ",default:a.author},{type:"input",name:"description",message:"Description: ",default:a.description}])];case 5:return o=n.sent(),c={filename:t.input,author:o.author,description:o.description},[4,i.prompt([{type:"confirm",name:"confirm",message:"Are you sure to update ?\n\tOld: ".concat(A(a),"\n\tNew:").concat(A(c))}])];case 6:if(!1===n.sent())return[2];r.forEach((function(e){e.filename===t.input&&(e=c)})),(l=g()).mmd.labels=r,s.writeFileSync(b(),u.stringify(l,4,2)),n.label=7;case 7:return[2]}}))}))}function j(){return t(this,void 0,void 0,(function(){var e,t,r,a,o;return n(this,(function(n){switch(n.label){case 0:return 0===(e=g().mmd.labels).length?(m("No custom labels").fail(),[2]):(t=e.map((function(e){return{name:e.filename,value:e.filename,checked:!1}})),[4,i.prompt([{type:"checkbox",name:"filename",message:"Which label(s) do you want to delete ?",choices:t}])]);case 1:return r=n.sent(),[4,i.prompt([{type:"confirm",name:"confirm",message:"Are you sure to delete these labels ?"}])];case 2:return!1===n.sent().confirm||(a=[],e.forEach((function(e){!1===r.filename.includes(e.filename)&&a.push(e)})),(o=g()).mmd.labels=a,s.writeFileSync(b(),u.stringify(o,4,2)),m("Delete successfully").succeed()),[2]}}))}))}function C(e){var t=new Date,n=t.getFullYear().toString().padStart(4,"0"),r=(t.getMonth()+1).toString().padStart(2,"0"),a=t.getDate().toString().padStart(2,"0"),i=t.getHours().toString().padStart(2,"0"),o=t.getMinutes().toString().padStart(2,"0"),c=t.getSeconds().toString().padStart(2,"0");return!0===e?"".concat(n,"-").concat(r,"-").concat(a," ").concat(i,":").concat(o,":").concat(c):"".concat(n,"-").concat(r,"-").concat(a)}function N(e){var t="./README.md";return void 0!==e&&(t=e.endsWith(".md")?e:e+=".md"),t}function R(e){return e.includes("\\")?e.split("\\").pop():e.includes("/")?e.split("/").pop():e}function T(e,t,n){var r=o(v(),"template","MuCli","README.md"),a=s.readFileSync(r,"utf-8"),i=C(!1),c=C(!0),u=a.split("\n");return u.forEach((function(r,a){var o;if(1===a&&(o=r.replace("author",e),u[a]=o),2===a&&(o=r.replace("description",t),u[a]=o),4===a&&(o=r.replace("update",i),u[a]=o),9===a&&(o=r.replace("modify",c),u[a]=o),7===a&&(o=void 0!==n?r.replace("create",n):r.replace("create",c),u[a]=o),3===a){if(void 0!==n){var s=n.split(" ")[0];o=r.replace("date",s)}else o=r.replace("date",i);u[a]=o}})),u.join("\n")}function U(e){var t;if(void 0===e)t="README.md";else if(e.includes(".")){if("md"!==e.split(".").pop())return!1;t=e}else t="".concat(e,".md");if(!s.existsSync(t))return!1;var n=s.readFileSync(t,"utf-8").split("\n");if(n.length<10||"---"!==n[0]||"---"!==n[5])return!1;var r={author:"",description:"",date:"",update:"",create:"",modify:""};for(var a in n.forEach((function(e,t){1===t&&(r.author=e.split("Author: ")[1].trim()),2===t&&(r.description=e.split("Description: ")[1].trim()),3===t&&(r.date=e.split("Date: ")[1].trim()),4===t&&(r.update=e.split("Update: ")[1].trim()),7===t&&(r.create=e.split("`")[3]),9===t&&(r.modify=e.split("`")[1])})),r){var i=r[a];if(""===i||void 0===i)return!1}return r}function L(e){return t(this,void 0,void 0,(function(){var t,r,a,o;return n(this,(function(n){switch(n.label){case 0:return t=R(e),[4,i.prompt([{type:"input",name:"title",message:"Title:",default:t}])];case 1:return r=n.sent(),a=function(e){var t=g().mmd,n=t.defaultLabel,r=t.labels.find((function(t){return t.filename===e}));return void 0===r&&(r=n),r}(r.title),[4,i.prompt([{type:"input",name:"author",message:"Author:",default:a.author},{type:"input",name:"description",message:"Description:",default:a.description}])];case 2:return o=n.sent(),[2,{filename:r.title,author:o.author,description:o.description}]}}))}))}function O(e){return t(this,void 0,void 0,(function(){var t,r,a,o,c,u,l;return n(this,(function(n){switch(n.label){case 0:return t=R(e),s.existsSync(e)?(r=U(e),a=[{name:"Create new file",value:"create"}],!1!==r?a.unshift({name:"Update frontmatter",value:"update"}):a.unshift({name:"Insert frontmatter",value:"insert"}),[4,i.prompt([{type:"list",name:"action",message:"File ".concat(d.yellow(t)," already exists, what do you want to do?"),choices:a,default:!1===r?"insert":"update"}])]):[3,7];case 1:switch(o=n.sent(),o.action){case"update":return[3,2];case"insert":return[3,4];case"create":return[3,6]}return[3,7];case 2:return[4,W(e)];case 3:case 5:return n.sent(),[2];case 4:return[4,I(e)];case 6:return[3,7];case 7:return[4,L(e)];case 8:return c=n.sent(),u=m("Creating markdown file").start(),l=T(c.author,c.description),s.createFileSync(e),s.writeFileSync(e,l),u.succeed("Markdown file created"),[2]}}))}))}function W(e){return t(this,void 0,void 0,(function(){var t,a,o,c,u;return n(this,(function(n){switch(n.label){case 0:return t=R(e),!1!==(a=U(e))?[3,4]:[4,i.prompt([{type:"confirm",name:"create",message:"Frontmatter not found in ".concat(d.yellow(t),", create?"),default:!0}])];case 1:return!0!==n.sent().create?[3,3]:[4,O(e)];case 2:n.sent(),n.label=3;case 3:return[3,6];case 4:return[4,i.prompt([{type:"confirm",name:"update",message:"Frontmatter found in ".concat(d.yellow(t),", update?"),default:!0}])];case 5:!0===n.sent().update&&(o=m("Updating frontmatter").start(),c=T(a.author,a.description,a.create),(u=s.readFileSync(e,"utf-8").split("\n")).splice.apply(u,r([0,11],c.split("\n"),!1)),s.writeFileSync(e,u.join("\n")),o.succeed("Frontmatter updated")),n.label=6;case 6:return[2]}}))}))}function I(e){return t(this,void 0,void 0,(function(){var t,a,i,o;return n(this,(function(n){switch(n.label){case 0:return[4,L(e)];case 1:return t=n.sent(),a=m("Inserting frontmatter").start(),i=T(t.author,t.description),(o=s.readFileSync(e,"utf-8").split("\n")).splice.apply(o,r([0,0],i.split("\n"),!1)),s.writeFileSync(e,o.join("\n")),a.succeed("Frontmatter inserted"),[2]}}))}))}F.name("dev").description("A cli tool for devtools").version(D,"-sv, --subversion"),F.command("run [script]").description("run pnpm script").action((function(e){return t(void 0,void 0,void 0,(function(){var t,r,a,i;return n(this,(function(n){var o;if(t="build",o=h(),r=Object.keys(o.scripts),void 0!==e){if(!r.includes(e))return m("Scripts: ".concat(d.blue(e)," not found")).fail(),[2];t=e}return a="pnpm ".concat(t),i=m("Running scripts: ".concat(d.blue(a))).start(),l("pnpm ".concat(t),{cwd:v()},(function(e,t,n){var r="";null!==e&&(r=e.message),null!==n&&""!==n&&(r=""===r?n:"".concat(r,"\n").concat(n)),""!==r?(r="Scripts: ".concat(d.blue(a)," run failed\n").concat(d.red(r,t)),i.fail(r)):(r="Scripts: ".concat(d.blue(a)," successfully"),i.succeed(r)),i.stop()})),[2]}))}))})),F.command("update").description("update config file").action((function(){var e=b(!0),t=u.load(e);t.update=Math.floor(Date.now()/1e3),s.writeFileSync(e,u.stringify(t,4,2))}));var P=new a("mmd"),q=y(f.mmd);P.name("mmd").description("A cli tool for markdown").version(q,"-sv, --subversion"),P.command("label").description("label crud").action((function(){return t(void 0,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,k()];case 1:return e.sent(),[2]}}))}))})),P.command("new [name]").description("create markdown file").action((function(e){return t(void 0,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,O(N(e))];case 1:return t.sent(),[2]}}))}))})),P.command("update [name]").description("update markdown frontmatter").action((function(e){return t(void 0,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,W(N(e))];case 1:return t.sent(),[2]}}))}))})),function(e,t){for(var n=w(),r=0,a=t;r<a.length;r++){var i=a[r];n.includes(i.name())&&e.addCommand(i)}}(S,[P,F]),S.parse(e.argv);
