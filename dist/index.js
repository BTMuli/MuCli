#!/usr/bin/env node
import e from"process";import{__awaiter as t,__generator as n,__spreadArray as r}from"tslib";import{Command as i}from"commander";import o from"inquirer";import{resolve as c}from"path";import a from"app-root-path";import u from"fs-extra";import s from"yamljs";import{exec as d}from"child_process";import l from"chalk";import m from"ora";var p;function f(){return a.path}function v(){var e=a.resolve("package.json");return u.readJSONSync(e)}function h(e){return v().subVersion[e]}function y(e){void 0===e&&(e=!1);var t=a.resolve("config"),n=c(t,"default.yml");if(e)return n;var r=s.load(n).update,i=c(t,"user.yml");return u.existsSync(i)||u.copyFileSync(n,i),s.load(i).update<r&&u.copyFileSync(n,i),i}function b(e){void 0===e&&(e=!1);var t=y(e);return s.load(t)}function g(){var e=b(),t=[];return e.dev.enable&&t.push("dev"),e.mmd.enable&&t.push("mmd"),t}!function(e){e.dev="dev",e.mmd="mmd"}(p||(p={}));var w=new i;w.name("muc").description(v().description).version(v().version,"-v, --version"),w.command("set").description("set subcommand on or off").action((function(){return t(void 0,void 0,void 0,(function(){var e,r,i;return n(this,(function(c){switch(c.label){case 0:return e=["dev","mmd"],r=g(),i=e.map((function(e){return r.includes(e)?{name:e,value:e,checked:!0}:{name:e,value:e,checked:!1}})),[4,o.prompt([{type:"checkbox",name:"command",message:"Please select the subcommand you want to open",choices:i}]).then((function(e){return t(void 0,void 0,void 0,(function(){return n(this,(function(t){return function(e){var t=b();t.dev.enable=e.includes("dev"),t.mmd.enable=e.includes("mmd");var n=y();u.writeFileSync(n,s.stringify(t,4,2))}(e.command),[2]}))}))}))];case 1:return c.sent(),[2]}}))}))}));var S=new i("dev"),F=h(p.dev);function k(e){var t="./README.md";return void 0!==e&&(t=e.endsWith(".md")?e:e+=".md"),t}function D(e,t,n){var r=c(f(),"template","MuCli","README.md"),i=u.readFileSync(r,"utf-8"),o=new Date,a="".concat(o.getFullYear(),"-").concat(o.getMonth(),"-").concat(o.getDate()),s="".concat(o.getHours(),":").concat(o.getMinutes(),":").concat(o.getSeconds()),d="".concat(a," ").concat(s),l=i.split("\n");return l.forEach((function(r,i){var o;if(1===i&&(o=r.replace("author",e),l[i]=o),2===i&&(o=r.replace("description",t),l[i]=o),4===i&&(o=r.replace("update",a),l[i]=o),9===i&&(o=r.replace("modify",d),l[i]=o),7===i&&(o=void 0!==n?r.replace("create",n):r.replace("create",d),l[i]=o),3===i){if(void 0!==n){var c=n.split(" ")[0];o=r.replace("create",c)}else o=r.replace("create",a);l[i]=o}})),l.join("\n")}function E(e){var t;if(void 0===e)t="README.md";else if(e.includes(".")){if("md"!==e.split(".").pop())return!1;t=e}else t="".concat(e,".md");if(!u.existsSync(t))return!1;var n=u.readFileSync(t,"utf-8").split("\n");if(n.length<10||"---"!==n[0]||"---"!==n[5])return!1;var r={author:"",description:"",date:"",update:"",create:"",modify:""};for(var i in n.forEach((function(e,t){1===t&&(r.author=e.split("Author: ")[1].trim()),2===t&&(r.description=e.split("Description: ")[1].trim()),3===t&&(r.date=e.split("Date: ")[1].trim()),4===t&&(r.update=e.split("Update: ")[1].trim()),7===t&&(r.create=e.split("`")[3]),9===t&&(r.modify=e.split("`")[1])})),r){var o=r[i];if(""===o||void 0===o)return!1}return r}function M(e){return t(this,void 0,void 0,(function(){var r,i=this;return n(this,(function(c){switch(c.label){case 0:return r=(a=e).includes("\\")?a.split("\\").pop():a.includes("/")?a.split("/").pop():a,u.existsSync(e)?!1!==E(e)?[3,1]:(console.log("insert"),[2]):[3,3];case 1:return[4,A(e)];case 2:case 4:return c.sent(),[2];case 3:return[4,o.prompt([{type:"input",name:"title",message:"Title:",default:r}]).then((function(r){return t(i,void 0,void 0,(function(){var t;return n(this,(function(n){switch(n.label){case 0:return t=function(e){var t=b().mmd,n=t.defaultLabel,r=t.labels.find((function(t){return t.filename===e}));return void 0===r&&(r=n),r}(r.title),[4,o.prompt([{type:"input",name:"author",message:"Author:",default:t.author},{type:"input",name:"description",message:"Description:",default:t.description}]).then((function(t){var n=m("Creating markdown file").start(),r=D(t.author,t.description);u.createFileSync(e),u.writeFileSync(e,r),n.succeed("Markdown file created")}))];case 1:return n.sent(),[2]}}))}))}))]}var a}))}))}function A(e){return t(this,void 0,void 0,(function(){var i,c=this;return n(this,(function(a){switch(a.label){case 0:return!1!==(i=E(e))?[3,2]:[4,o.prompt([{type:"confirm",name:"create",message:"Create frontmatter?",default:!0}]).then((function(r){return t(c,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return!0!==r.create?[3,2]:[4,M(e)];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}))];case 1:return a.sent(),[3,4];case 2:return[4,o.prompt([{type:"confirm",name:"update",message:"Update frontmatter?",default:!0}]).then((function(o){return t(c,void 0,void 0,(function(){var t,c,a;return n(this,(function(n){return!0===o.update&&(t=m("Updating frontmatter").start(),c=D(i.author,i.description,i.create),(a=u.readFileSync(e,"utf-8").split("\n")).splice.apply(a,r([0,10],c.split("\n"),!1)),u.writeFileSync(e,a.join("\n")),t.succeed("Frontmatter updated")),[2]}))}))}))];case 3:a.sent(),a.label=4;case 4:return[2]}}))}))}S.name("dev").description("A cli tool for devtools").version(F,"-sv, --subversion"),S.command("run [script]").description("run pnpm script").action((function(e){return t(void 0,void 0,void 0,(function(){var t,r,i,o;return n(this,(function(n){var c;if(t="build",c=v(),r=Object.keys(c.scripts),void 0!==e){if(!r.includes(e))return m("Scripts: ".concat(l.blue(e)," not found")).fail(),[2];t=e}return i="pnpm ".concat(t),o=m("Running scripts: ".concat(l.blue(i))).start(),d("pnpm ".concat(t),{cwd:f()},(function(e,t,n){var r="";null!==e&&(r=e.message),null!==n&&""!==n&&(r=""===r?n:"".concat(r,"\n").concat(n)),""!==r?(r="Scripts: ".concat(l.blue(i)," run failed\n").concat(l.red(r,t)),o.fail(r)):(r="Scripts: ".concat(l.blue(i)," successfully"),o.succeed(r)),o.stop()})),[2]}))}))})),S.command("update").description("update config file").action((function(){var e=y(!0),t=s.load(e);t.update=Math.floor(Date.now()/1e3),u.writeFileSync(e,s.stringify(t,4,2))}));var j=new i("mmd"),x=h(p.mmd);j.name("mmd").description("A cli tool for markdown").version(x,"-sv, --subversion"),j.command("label").description("label crud").action((function(){console.log("label")})),j.command("new [name]").description("create markdown file").action((function(e){return t(void 0,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,M(k(e))];case 1:return t.sent(),[2]}}))}))})),j.command("update [name]").description("update markdown frontmatter").action((function(e){return t(void 0,void 0,void 0,(function(){return n(this,(function(t){switch(t.label){case 0:return[4,A(k(e))];case 1:return t.sent(),[2]}}))}))})),function(e,t){for(var n=g(),r=0,i=t;r<i.length;r++){var o=i[r];n.includes(o.name())&&e.addCommand(o)}}(w,[j,S]),w.parse(e.argv);
