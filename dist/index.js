#!/usr/bin/env node
import t from"process";import{__awaiter as e,__generator as n,__spreadArray as r}from"tslib";import{Command as i}from"commander";import a from"inquirer";import{resolve as o}from"path";import c from"app-root-path";import s from"fs-extra";import u from"yamljs";import{exec as d}from"child_process";import l from"chalk";import p from"ora";var m;function f(){return c.path}function v(){var t=c.resolve("package.json");return s.readJSONSync(t)}function h(t){return v().subVersion[t]}function y(t){void 0===t&&(t=!1);var e=c.resolve("config"),n=o(e,"default.yml");if(t)return n;var r=u.load(n).update,i=o(e,"user.yml");return s.existsSync(i)||s.copyFileSync(n,i),u.load(i).update<r&&s.copyFileSync(n,i),i}function g(t){void 0===t&&(t=!1);var e=y(t);return u.load(e)}function S(){var t=g(),e=[];return t.dev.enable&&e.push("dev"),t.mmd.enable&&e.push("mmd"),e}!function(t){t.dev="dev",t.mmd="mmd"}(m||(m={}));var w=new i;w.name("muc").description(v().description).version(v().version,"-v, --version"),w.command("set").description("set subcommand on or off").action((function(){return e(void 0,void 0,void 0,(function(){var t,r,i;return n(this,(function(o){switch(o.label){case 0:return t=["dev","mmd"],r=S(),i=t.map((function(t){return r.includes(t)?{name:t,value:t,checked:!0}:{name:t,value:t,checked:!1}})),[4,a.prompt([{type:"checkbox",name:"command",message:"Please select the subcommand you want to open",choices:i}]).then((function(t){return e(void 0,void 0,void 0,(function(){return n(this,(function(e){return function(t){var e=g();e.dev.enable=t.includes("dev"),e.mmd.enable=t.includes("mmd");var n=y();s.writeFileSync(n,u.stringify(e,4,2))}(t.command),[2]}))}))}))];case 1:return o.sent(),[2]}}))}))}));var b=new i("dev"),F=h(m.dev);function k(t){var e=new Date,n=e.getFullYear().toString().padStart(4,"0"),r=(e.getMonth()+1).toString().padStart(2,"0"),i=e.getDate().toString().padStart(2,"0"),a=e.getHours().toString().padStart(2,"0"),o=e.getMinutes().toString().padStart(2,"0"),c=e.getSeconds().toString().padStart(2,"0");return!0===t?"".concat(n,"-").concat(r,"-").concat(i," ").concat(a,":").concat(o,":").concat(c):"".concat(n,"-").concat(r,"-").concat(i)}function D(t){var e="./README.md";return void 0!==t&&(e=t.endsWith(".md")?t:t+=".md"),e}function E(t){return t.includes("\\")?t.split("\\").pop():t.includes("/")?t.split("/").pop():t}function M(t,e,n){var r=o(f(),"template","MuCli","README.md"),i=s.readFileSync(r,"utf-8"),a=k(!1),c=k(!0),u=i.split("\n");return u.forEach((function(r,i){var o;if(1===i&&(o=r.replace("author",t),u[i]=o),2===i&&(o=r.replace("description",e),u[i]=o),4===i&&(o=r.replace("update",a),u[i]=o),9===i&&(o=r.replace("modify",c),u[i]=o),7===i&&(o=void 0!==n?r.replace("create",n):r.replace("create",c),u[i]=o),3===i){if(void 0!==n){var s=n.split(" ")[0];o=r.replace("date",s)}else o=r.replace("date",a);u[i]=o}})),u.join("\n")}function A(t){var e;if(void 0===t)e="README.md";else if(t.includes(".")){if("md"!==t.split(".").pop())return!1;e=t}else e="".concat(t,".md");if(!s.existsSync(e))return!1;var n=s.readFileSync(e,"utf-8").split("\n");if(n.length<10||"---"!==n[0]||"---"!==n[5])return!1;var r={author:"",description:"",date:"",update:"",create:"",modify:""};for(var i in n.forEach((function(t,e){1===e&&(r.author=t.split("Author: ")[1].trim()),2===e&&(r.description=t.split("Description: ")[1].trim()),3===e&&(r.date=t.split("Date: ")[1].trim()),4===e&&(r.update=t.split("Update: ")[1].trim()),7===e&&(r.create=t.split("`")[3]),9===e&&(r.modify=t.split("`")[1])})),r){var a=r[i];if(""===a||void 0===a)return!1}return r}function j(t){return e(this,void 0,void 0,(function(){var e,r,i,o;return n(this,(function(n){switch(n.label){case 0:return e=E(t),[4,a.prompt([{type:"input",name:"title",message:"Title:",default:e}])];case 1:return r=n.sent(),i=function(t){var e=g().mmd,n=e.defaultLabel,r=e.labels.find((function(e){return e.filename===t}));return void 0===r&&(r=n),r}(r.title),[4,a.prompt([{type:"input",name:"author",message:"Author:",default:i.author},{type:"input",name:"description",message:"Description:",default:i.description}])];case 2:return o=n.sent(),[2,{filename:r.title,author:o.author,description:o.description}]}}))}))}function x(t){return e(this,void 0,void 0,(function(){var e,r,i,o,c,u,d;return n(this,(function(n){switch(n.label){case 0:return e=E(t),s.existsSync(t)?(r=A(t),i=[{name:"Create new file",value:"create"}],!1!==r?i.unshift({name:"Update frontmatter",value:"update"}):i.unshift({name:"Insert frontmatter",value:"insert"}),[4,a.prompt([{type:"list",name:"action",message:"File ".concat(l.yellow(e)," already exists, what do you want to do?"),choices:i,default:!1===r?"insert":"update"}])]):[3,7];case 1:switch(o=n.sent(),o.action){case"update":return[3,2];case"insert":return[3,4];case"create":return[3,6]}return[3,7];case 2:return[4,C(t)];case 3:case 5:return n.sent(),[2];case 4:return[4,R(t)];case 6:return[3,7];case 7:return[4,j(t)];case 8:return c=n.sent(),u=p("Creating markdown file").start(),d=M(c.author,c.description),s.createFileSync(t),s.writeFileSync(t,d),u.succeed("Markdown file created"),[2]}}))}))}function C(t){return e(this,void 0,void 0,(function(){var e,i,o,c,u;return n(this,(function(n){switch(n.label){case 0:return e=E(t),!1!==(i=A(t))?[3,4]:[4,a.prompt([{type:"confirm",name:"create",message:"Frontmatter not found in ".concat(l.yellow(e),", create?"),default:!0}])];case 1:return!0!==n.sent().create?[3,3]:[4,x(t)];case 2:n.sent(),n.label=3;case 3:return[3,6];case 4:return[4,a.prompt([{type:"confirm",name:"update",message:"Frontmatter found in ".concat(l.yellow(e),", update?"),default:!0}])];case 5:!0===n.sent().update&&(o=p("Updating frontmatter").start(),c=M(i.author,i.description,i.create),(u=s.readFileSync(t,"utf-8").split("\n")).splice.apply(u,r([0,10],c.split("\n"),!1)),s.writeFileSync(t,u.join("\n")),o.succeed("Frontmatter updated")),n.label=6;case 6:return[2]}}))}))}function R(t){return e(this,void 0,void 0,(function(){var e,i,a,o;return n(this,(function(n){switch(n.label){case 0:return[4,j(t)];case 1:return e=n.sent(),i=p("Inserting frontmatter").start(),a=M(e.author,e.description),(o=s.readFileSync(t,"utf-8").split("\n")).splice.apply(o,r([0,0],a.split("\n"),!1)),s.writeFileSync(t,o.join("\n")),i.succeed("Frontmatter inserted"),[2]}}))}))}b.name("dev").description("A cli tool for devtools").version(F,"-sv, --subversion"),b.command("run [script]").description("run pnpm script").action((function(t){return e(void 0,void 0,void 0,(function(){var e,r,i,a;return n(this,(function(n){var o;if(e="build",o=v(),r=Object.keys(o.scripts),void 0!==t){if(!r.includes(t))return p("Scripts: ".concat(l.blue(t)," not found")).fail(),[2];e=t}return i="pnpm ".concat(e),a=p("Running scripts: ".concat(l.blue(i))).start(),d("pnpm ".concat(e),{cwd:f()},(function(t,e,n){var r="";null!==t&&(r=t.message),null!==n&&""!==n&&(r=""===r?n:"".concat(r,"\n").concat(n)),""!==r?(r="Scripts: ".concat(l.blue(i)," run failed\n").concat(l.red(r,e)),a.fail(r)):(r="Scripts: ".concat(l.blue(i)," successfully"),a.succeed(r)),a.stop()})),[2]}))}))})),b.command("update").description("update config file").action((function(){var t=y(!0),e=u.load(t);e.update=Math.floor(Date.now()/1e3),s.writeFileSync(t,u.stringify(e,4,2))}));var U=new i("mmd"),I=h(m.mmd);U.name("mmd").description("A cli tool for markdown").version(I,"-sv, --subversion"),U.command("label").description("label crud").action((function(){console.log("label")})),U.command("new [name]").description("create markdown file").action((function(t){return e(void 0,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,x(D(t))];case 1:return e.sent(),[2]}}))}))})),U.command("update [name]").description("update markdown frontmatter").action((function(t){return e(void 0,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,C(D(t))];case 1:return e.sent(),[2]}}))}))})),function(t,e){for(var n=S(),r=0,i=e;r<i.length;r++){var a=i[r];n.includes(a.name())&&t.addCommand(a)}}(w,[U,b]),w.parse(t.argv);
